#!/bin/bash
# vi: set sw=4 ts=4 ai:

# Determine the program name and the 'running directory'
IAM="${0##*/}"
CRD="$( [[ "${0:0:2}" = "./" ]] &&
	{	printf "${PWD}/${0#./}"
	} || {
		printf "${0}"
	})"
CRD="${CRD%/*}"
CUR="${PWD}"

# Make sure all language settings are correct
export LANG=C

# Save the shell settings
SETA=0; [[ ${-} = *a* ]] && SETA=1
SETE=0; [[ ${-} = *e* ]] && SETE=1
SETU=0; [[ ${-} = *u* ]] && SETU=1
SETX=0; [[ ${-} = *x* ]] && SETX=1

# Set and unset the needed shell settings
set +o noclobber		# Overwrite existing files, if needed
set -o nounset			# Do not allow uninitialized variables
set +o errexit			# No returncode checking

# Set the PATH
PATH=/bin:/usr/bin:${PATH}

# Read the OpenShift functions
source ${OPENSHIFT_CARTRIDGE_SDK_BASH}

# Set constants and read constants
LIBDIR="${CRD}/../lib"
LIBRARY="${LIBDIR}/library"
[[ ! -r ${LIBRARY} ]] && { echo "${LIBRARY} not found"; exit 1; }
. ${LIBRARY} || { echo "Error reading ${LIBRARY}"; exit 1; }

client_result "Teardown called Planon"
source=${OPENSHIFT_PLN_DIR}logs/*
dest=${OPENSHIFT_PLN_DIR}mount/live/logging/logs
heaps=${OPENSHIFT_PLN_DIR}mount/live/logging/heapdump
showstatus "0" "Creating fileshare mount before exporting logfiles"

share 'create'

showstatus "0" "Remove symlinks to logfiles from previous restarts"
rm -f ${OPENSHIFT_PLN_DIR}logs/logfiles*.zip

showstatus "0" "Compressing and storing logfiles outside of gear"
zip -j -r $dest/logfiles.beforerestart.$(date +%F_%H:%M).zip $source

showstatus "0" "Remove all obsolete logfiles over 10"
ls -1t $dest/logfiles*.zip | (i=0; while read f; do
  if [ $i -lt 10 ]; then
    ((i++))
    continue
  else
    rm -f "$f"
  fi
done)

share 'remove'
showstatus "0" "End share after export logfiles"

client_result "Teardown Planon finished"
